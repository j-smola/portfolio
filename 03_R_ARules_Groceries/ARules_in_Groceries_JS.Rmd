---
title: "Association Rules in Groceries"
author: "Janina Smoła"
date: "27/05/2018"

output:
  rmarkdown::html_document:
    theme: cerulean
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    highlight: pygments
---

<!-- OSTYLOWANIE -->
<style>
#TOC {
overflow:auto;
}
body {
text-align: justify}
h1 {
font-size: 24px
}
h2 {
font-size: 20px
}
h3 {
font-size: 18px
}
h1, .h1, h2, .h2, h3, .h3 {
margin-top: 20px;
color: #555555;
}
p.caption {
  font-style: bold italic;
  margin-bottom: 30px;
  margin-top: -10px;
  text-align: middle;
}
.list-group-item.active, .list-group-item.active {
  background-color: #022a50;
  border-color: #022a50;
}
pre code {
  font-size: 11px;
}
a {
  color: #022a50;
}
</style>

```{r, warning=FALSE, include=FALSE}
library(arules)
library(arulesViz)
library(dplyr)
library(igraph)
# https://bookdown.org/yihui/rmarkdown/
# https://holtzy.github.io/Pimp-my-rmd/#hyperlink_to_a_section
col_x <- '#022a50'
col_0 <- '#1995dc' # błekit
col_1 <- '#317eac' # nieb
col_2 <- '#73a839' # ziel
col_3 <- '#ff6707' # pomarańcz
col_4 <- '#c71c22' # czerwony
par(oma = c(0, 0, 0, 0))
par(mar = c(5.1, 4.1, 2, 2.1))
```

<br>

# WSTĘP

**OPIS POSTAWIONEGO ZADANIA**

Właściciel sklepu wielobranżowego postanowił zysk zainwestować w rozwój; zaplanowano powiększenie powierzchni użytkowej sklepu oraz lekką rearanżacje. Wychodząc naprzeciw potrzebom klientów rozwijane miałyby być działy/grupy produktów cieszące się największym zainteresowaniem, a o ich lokalizacji w obrębie nowej powierzchni zadecydować miała zasada maksymalizacji ewentualnych zakupów (możliwość zakupów impulsowych). 

Wybór działów/grup produktów do rozwoju i ewentualny ich układ bazować ma na analizie list zakupów (najpopularniejsze), natomiast ich wzajemną lokalizację określić miałyby najciekwasze/ najsilniejsze reguły asocjacyjne.
Na podstawie liczby transakcji w wykorzystywanym zbiorze zakłada się, że sklep ma rozmiary marketu osiedlowego - 9835 transakcji z okresu 1 miesiąca tj. ok. 30 transakcji na godzinę, przy 12-godzinnym dniu pracy i 7-dniowym tygodniu pracy.

<br>

**CELE GŁÓWNE EKSPERYMENTU**

1. wybór interesujących reguł (definicja na bazie dostępnych parametrów reguł);
2. wybór reguły najlepszej;
3. znalezienie praktycznych zastosować odkrytych reguł.


<u>Przy opracowaniu zadania wykorzystano artykuły:</u>
 
* https://cran.r-project.org/web/packages/arulesViz/vignettes/arulesViz.pdf

* https://cran.r-project.org/web/packages/arules/vignettes/arules.pdf

* http://r-statistics.co/Association-Mining-With-R.html


**UWAGA** komentarze są w jezyku polski, za wyjątkiem tytułów rysunków, które są w języku angielskim - tak jak wykorzystywana baza.

<br><br>

# EKSPERYMENT - ELEMENTY CZĘSTE

## Źrodło - zbiór _Groceries_, lista produktów i charakterystyka bazy
<br>
Ładowanie danych
```{r}
data(Groceries)
typeof(Groceries) 
class(Groceries)
```
<br>
Rozmiar zbioru
```{r}
dim(Groceries)
```
<br>
Wszytkie produktu w zbiorze transaksyjnym
```{r}
itemLabels(Groceries) 
```
<br>
Opis zbioru
```{r}
summary(Groceries)
```

<br>
Przykładowe transakcje
```{r}
inspect(head(Groceries, 3)); inspect(tail(Groceries, 3)) 
```

<br>
Rozmiar wektorów definiujących macierz rzadką zbioru danych _Groceries_ ( _indices_ definijące produkty oraz _pointers_ - kolejny element macierzy rzadkiej)
```{r}
length(Groceries@data@i); length(Groceries@data@p) 
```

<br>
Struktura zbior
```{r}
str(Groceries@itemInfo)
```
<br>
Transakcje - liczba produktów
```{r, fig.align="center", fig.height=3, out.width = "100%", fig.cap="Size - number of products in each of transaction"}
barplot(table(size(Groceries)), col = col_1, cex.axis = 0.8, cex.names = 0.8, las = 1)
```
Rozkład
```{r, fig.align="center", fig.height=3, fig.cap="Size - number of products in each of transaction"}
boxplot(size(Groceries), col = col_1, horizontal = TRUE, cex.axis = 0.8, cex.lab = 0.8, 
        frame = FALSE, ylim = c(0, 40))
abline(v = 3, col = col_3, lwd = 2, lty = 2)
```
<br>
Macierz rzadka zbioru danych
```{r, fig.align="center", fig.cap="Image of spare matrix = transaction & products"}
image(sample(Groceries, 100))
```
<br>

**PODSUMOWANIE - CHARAKTERYSTYKA BAZY DANYCH**

1. zbiór zawiera 9835 transakcji złożonych z 169 produktów; 
2. zbiór danych jest raczej rzadki (gęstość - density of 0.02609146 -> 2,6%); 
3. najczęściej występującym produktem jest 'mleko' ( _whole milk_ - 2513), a następnie 'inne warzywa' ( _other vegetables_ - 1903); 
4. typowa transakcja (lista zakupów) zawiera mniej niż 5 produktów (średnia = 4.409) - <u>mediana wynosi 3</u>; 
5. zbiór danych zawiera dodatkowe inforamcje o produktach - grupowanie produktów na dwóch poziomach, tj. _level 1_ (10 elementów) i _level 2_ (55 elementów).

<br>

## Analiza listy produktów
```{r, warning=FALSE, include=FALSE}
df_groc <- Groceries@itemInfo
```
Weryfikacja kompletności danych, liczebności działów i grup produktów.
```{r}
any(is.na(df_groc)) 
levels(df_groc$level1)
```

Lista produktów przypisanych do poszczególnych grup produktowych ( _level 2_ ):
```{r, warning=FALSE, include=FALSE}
list_lvl2 <- list()
(lbl_lvl2 <- levels(df_groc$level2))

for (i in 1:length(lbl_lvl2)){ 
  name_lvl2 <- lbl_lvl2[i]
  iter_list <- df_groc %>% filter(level2 == lbl_lvl2[i]) %>% select(labels) %>% as.list()
  list_lvl2[name_lvl2] <- iter_list
}
```
```{r}
list_lvl2
```

Liczba produktów w grupie - ile grup ma okresloną liczbę produktów
```{r, warning=FALSE, include=FALSE}
len_list_lvl2 <- sapply(list_lvl2, function(x) length(x)) 
```
```{r, fig.align="center", fig.height=3, fig.cap="Number of items in each products' group"}
barplot(table(len_list_lvl2), col = col_1, cex.axis = 0.8, cex.names = 0.8, cex.lab = 0.8, las = 1,
        xlab = 'number of products in group', ylab = 'number of products\' group')
abline(h = 3, col = col_3, lwd = 2, lty = 2)
```
<br>


Transakcje wg produktów
```{r, warning=FALSE, include=FALSE}
Groceries_lvl2 <- aggregate(Groceries, by = 'level2')
```
```{r}
inspect(head(Groceries, 3))
```
Transakcje wg grup produktów (na  _level 2_ )
```{r}
inspect(head(Groceries_lvl2,3))
```
<br>

**PODSUMOWANIE DZIAŁY/ GRUPY TOWAROWE**

1. Poziom 1 ( _level 1_ ) określa najogólniejszy podział na działy w sklepie, których jest 10;
2. Natomiast poziom 2 ( _level 2_ ) określa dokładniejsze 55 grup produktów (grup towarowych);
3. Z uwagi na jakość analizy uznano, że do przygotowania decyzji zarządczych odpowiedniejsza będzie analiza oparta o poszczególne towary oraz na poziomie ogólniejszym grupy towarowe ( _level 2_ ). W daleszej części materiału analiza jest prowadzona dwutorowo - dla produktów i ich grup ( _level 2_ ).
4. W ramach grup _level 2_ 196 produktów podzielono na 55 grup produktowych, średnio grupa liczy 3 produkty, natomiast jest 7 grup z 6-cioma lub więcej produktami.

<br>

### Wykresy dla produktów z bazy _Groceries_

<!-- Wsparcie względne dla wszystkich 169 produktów -->
<!-- ```{r, fig.align="center", fig.cap="Plot of frequency for all products"} -->
<!-- itemFrequencyPlot(Groceries, population = Groceries, popCol = 'red', cex.names= 0.5, -->
<!--                   ylab = 'relative support') -->
<!-- ``` -->
<!-- <br> -->
20 produktów o najwyższym wsparciu względnym
```{r, fig.align="center", fig.cap="Plot of frequency for top 20 products"}
itemFrequencyPlot(Groceries, topN = 20, col = col_1, horiz = TRUE,
                  xlab = 'relative support', cex = 0.8, cex.axis = 0.8, cex.lab = 0.8, las = 1)
abline(v = 0.05, col = col_3, lwd = 2, lty = 2)
```
<br>
Produkty, dla których min wsparcie względne wynosi 0.10
```{r, fig.align="center", fig.height=3, fig.cap="Plot of frequency for products with min support = 0.1"}
itemFrequencyPlot(Groceries, support = 0.10, col = col_1, horiz = TRUE, 
                  xlab = 'relative support', cex = 0.8, cex.axis = 0.8, cex.lab = 0.8, las = 1)
abline(v = 0.10, col = col_3, lwd = 2, lty = 2)
```
<br>
Produkty, dla których min wsparcie względne wynosi 0.05
```{r, fig.align="center", fig.height=6, fig.cap="Plot of frequency for products with min support = 0.05"}
itemFrequencyPlot(Groceries, support = 0.05, col = col_1, horiz = TRUE, 
                  xlab = 'relative support', cex = 0.8, cex.axis = 0.8, cex.lab = 0.8, las = 1)
abline(v = 0.05, col = col_3, lwd = 2, lty = 2)
```

<br>

### Wykresy dla grup produktów z bazy _Groceries_ - level2

<!-- Wsparcie względne dla wszystkich 55 grup produktów -->
<!-- ```{r, fig.align="center", fig.cap="Plot of frequency for all products' groups"} -->
<!-- itemFrequencyPlot(Groceries_lvl2, population = Groceries_lvl2, popCol = 'red', cex.names= 0.5, -->
<!--                   ylab = 'relative support') -->
<!-- ``` -->
<!-- <br> -->
20 grup produktów o najwyższym wsparciu względnym
```{r, fig.align="center", fig.height=5.7, fig.cap="Plot of frequency for 20 top products' groups"}
itemFrequencyPlot(Groceries_lvl2, topN = 20, col = col_1, horiz = TRUE, 
                  xlab = 'relative support', cex = 0.8, cex.axis = 0.8, cex.lab = 0.8, las = 1)
abline(v = 0.05, col = col_3, lwd = 2, lty = 2)
```
<br>
Produkty, dla których min wsparcie względne wynosi 0.10
```{r, fig.align="center", fig.height=3.3, fig.cap="Plot of frequency for products' groups  with min support = 0.1"}
itemFrequencyPlot(Groceries_lvl2, support = 0.10, col = col_1, horiz = TRUE, 
                  xlab = 'relative support', cex = 0.8, cex.axis = 0.8, cex.lab = 0.8, las = 1)
abline(v = 0.10, col = col_3, lwd = 2, lty = 2)
```
<br>
Produkty, dla których min wsparcie względne wynosi 0.05
```{r, fig.align="center", fig.height=5, fig.cap="Plot of frequency for products' groups with min support = 0.5"}
itemFrequencyPlot(Groceries_lvl2, support = 0.05, col = col_1, horiz = TRUE, 
                  xlab = 'relative support', cex = 0.8, cex.axis = 0.8, cex.lab = 0.8, las = 1)
abline(v = 0.05, col = col_3, lwd = 2, lty = 2)
```

<br>

### Wsparcie i wsparcie względne poszczególnych produktów 

```{r, warning=FALSE, include=FALSE}
# wsparcie relatywne ~ prawdopodobieństow (tj. wsparcie absolutne/9835)
tab_freq <- itemFrequency(Groceries, type = 'relative')  ## frequency/support 
# uporządkowanie listy produktów wg malejącej wartości wsparcia względnego
tab_freq <- sort(tab_freq, decreasing = TRUE)
``` 

```{r, fig.align="center", fig.height=3, fig.cap="Relative support for each single product"}
boxplot(tab_freq, horizontal = TRUE, col = col_1, xlab = 'relative support', 
        cex.axis = 0.8, cex.lab = 0.8, frame = FALSE, ylim = c(0, 0.3))
```
Produkty o największym i najmniejszym wsparciu względnym
```{r}
head(tab_freq)
tail(tab_freq) 
```

<br>
 
Wsparcie absolutne/bezwzględne produktu (liczebność transakcji z danym produktem)

```{r, warning=FALSE, include=FALSE}
tab_freq_ab <- itemFrequency(Groceries, type = 'absolute') 
tab_freq_ab <- sort(tab_freq_ab, decreasing = TRUE)
```

```{r, fig.align="center", fig.height=3, fig.cap="Support for each single product"}
boxplot(tab_freq_ab, horizontal = TRUE, col = col_1, xlab = 'support', 
        cex.axis = 0.8, cex.lab = 0.8, frame = FALSE, ylim = c(0, 3000))
```

**Propozycje elementów z _minSup_**

+ elementy=produkty ze wsparciem względnym > 20% (wsparcie bezwzględne: 1968 = 0.20 * 9835)

```{r}
length(tab_freq[tab_freq > 0.20]); print(tab_freq[tab_freq > 0.20])
```
<br>

+ elementy=produkty ze wspaciem względnym >= 10% (wsparcie bezwzględne: 984 = 0.10 * 9835)

```{r}
length(tab_freq[tab_freq >= 0.1]) 
print(tab_freq[tab_freq >= 0.1])
```
<br>

+ elementy=produkty ze wspaciem względnym >= 5% (wsparcie bezwzględne: 490 = 0.05 * 9835)

```{r}
length(tab_freq[tab_freq >= 0.05]); print(tab_freq[tab_freq >= 0.05][1:5])
```
<br>

+ liczba elementów ze wspaciem >= 100 (~>1%)

```{r}
length(tab_freq_ab[tab_freq_ab >= 100]); print(tab_freq_ab[tab_freq_ab >= 100][1:5])
```

<br>

### Produkty częste

Wybór produktów częstych przy założeniu wsparcia względnego na poziomie 10% (984 transakcje: _minSup_ = 984, _minrSup_ = 0.10)
```{r}
(list_pop_products <- names(tab_freq_ab[tab_freq_ab > 984])) 
```
Grupy, do którch należą najpopularniejsze produkty
```{r}
filter(itemInfo(Groceries), labels %in% list_pop_products) %>% select(level2) %>% unique()
filter(itemInfo(Groceries), labels %in% list_pop_products) %>% select(level2) %>% table() %>% as.data.frame() %>% filter(Freq != 0)
```
<br><br>

**WNIOSKI**

Najczęsciej występujące produkty to: (= produkty częste o wsparciu większym od _minSup_ = 984)
```{r}
list_pop_products
```
<br>
Najczęściej występujące produkty należą do następujących grup produktów

| grupa produktów         |  produkty                                             |
|-------------------------|-------------------------------------------------------|
| bread and backed goods  |  1 produkt, tj. "rolls/buns"                          |          
|          dairy produce  |  2 produkt, tj. "whole milk"       "yogurt"           |     
|                  fruit  |  1 produkt, tj. "tropical fruit"                      |
|        non-alc. drinks  |  2 produkt, tj. "soda"             "bottled water"    |         
|             vegetables  |  2 produkt, tj. "other vegetables" "root vegetables"  |          


<br>

**SPRAWDZENIE (obliczenie apriori dla częstych elementów=produktów)**

```{r}
list_pop_products_spr  <- apriori(data = Groceries, ## object of class transactions
                                  parameter = list(support = 0.003, confidence = 0.2,
                                                   target = 'frequent itemsets'))
summary(list_pop_products_spr)

inspect(sort(subset(list_pop_products_spr, subset = count > 984)))
```
A zatem przy zastosowaniu metody alternatywnej uzyskany został ten sam wynik.

<br>

### Wsparcie i wsparcie względne grup produktów (level2)

```{r, warning=FALSE, include=FALSE}
# wsparcie relatywne ~ prawdopodobieństwo (tj. wsparcie absolutne/9835)
tab_freq_lvl2 <- itemFrequency(Groceries_lvl2, type = 'relative')  ## frequency/support 
# uporzadkowanie listy produktów wg malejącej wartości wsparcia względnego
tab_freq_lvl2 <- sort(tab_freq_lvl2, decreasing = TRUE)
```

```{r, fig.align="center", fig.height=3, fig.cap="Relative support for each single products' group"}
boxplot(tab_freq_lvl2, horizontal = TRUE, col = col_1, xlab = 'relative support', 
        cex.axis = 0.8, cex.lab = 0.8, frame = FALSE, ylim = c(0, 0.5))
```

Produkty o największym i najmniejszym wsparciu względnym
```{r}
head(tab_freq_lvl2)
tail(tab_freq_lvl2) 
```

<br><br>
 
Wsparcie absolutne/bezwzględne produktu (liczebność transakcji z danym produktem)

```{r, warning=FALSE, include=FALSE}
tab_freq_lvl2_ab <- itemFrequency(Groceries_lvl2, type = 'absolute') 
tab_freq_lvl2_ab <- sort(tab_freq_lvl2_ab, decreasing = TRUE)
```

```{r, fig.align="center", fig.height=3, fig.cap="Support for each single products' group"}
boxplot(tab_freq_lvl2_ab, horizontal = TRUE, col = col_1, xlab = 'support', 
        cex.axis = 0.8, cex.lab = 0.8, frame = FALSE, ylim = c(0, 5000))
```


**Propozycje elementów z _minSup_**

+ elementy=grupy produktów ze wsparciem względnym > 20% (wsparcie bezwzględne: 1968 = 0.20 * 9835)

```{r}
length(tab_freq_lvl2[tab_freq_lvl2 > 0.20]); print(tab_freq_lvl2[tab_freq_lvl2 > 0.20]) 
```
<br>

+ elementy=grupy produktów ze wspaciem względnym >= 10% (wsparcie bezwzględne: 984 = 0.10 * 9835)

```{r}
length(tab_freq_lvl2[tab_freq_lvl2 > 0.10]); print(tab_freq_lvl2[tab_freq_lvl2 > 0.10][1:5])
```
<br>

+ elementy=grupy produktów ze wspaciem względnym >= 5% (wsparcie bezwzględne: 490 = 0.05 * 9835)

```{r}
length(tab_freq_lvl2[tab_freq_lvl2 >= 0.05]); print(tab_freq_lvl2[tab_freq_lvl2 >= 0.05][1:5])
```
<br>

+ liczba elementów=grup produktów ze wspaciem >= 100 (~>1%)

```{r}
length(tab_freq_lvl2_ab[tab_freq_lvl2_ab >= 100]); print(tab_freq_lvl2_ab[tab_freq_lvl2_ab >= 100][1:5])
```

<br>

### Grupy produktów częste (level2)
 
Wybór grup produktów częstych przy założeniu wsparcia względnego na poziomie 10% (984 transakcje: _minSup_ = 984, _minrSup_ = 0.10)
```{r}
(list_pop_gr_products <- names(sort(tab_freq_lvl2_ab[tab_freq_lvl2_ab > 984], decreasing = TRUE)))
```

**Wnioski**

Najczęsciej występujące grupy prduktów to:

1. Produkty z grupy produkty mleczne występują w 4357 z 9835 transakcji (44,3%);
2. produkty z grupy pieczywo i wypieki - w 3398 z 9835 transakcji (34,5%);
3. produkty z grupy napoje niealkoholowe - 3127 z 9835 transakcji (31,8%);
4. produkty z grupy warzywa - 2685 z 9835 transakcji (27,3%);
5. produkty z grupy owoce - 2450 z 9835 transakcji (24,9%).

<br>

**SPRAWDZENIE (obliczenie apriori dla częstych elementów=grupy produkótw)**

```{r}
list_pop_gr_products_spr  <- apriori(data = Groceries_lvl2, ## object of class transactions
                                     parameter = list(support = 0.003, confidence = 0.2, # zmienione na 1 
                                                      target = 'frequent itemsets'))
summary(list_pop_gr_products_spr)

inspect(sort(subset(list_pop_gr_products_spr, subset = count > 984)))
```
Potwierdza to wcześniejsze wyniki - otrzymano tą samą listę najczęstszych grup produktowych.

<br>

### Częste produkty i częste grupy

Analiza, które produkty są częste i z jakich grup produktów występ, mających największe wsparcie (>30% transakcji, tzn. dla trzech pierwszych)

_UWAGA_ Potwierdzenie obserwacji, iż wsprcie częstej grupu 'budują' dwa-trzy produkty (linie poziome = średnia dla grupy)

1. grup 'produkty mleczne' ( _dairy produce_ ) - produkty:

```{r}
(items_lvl2_1 <- list_lvl2$`dairy produce`)
```

Wsparcie produktów
```{r}
(gr_prod_1 <- sort(tab_freq[items_lvl2_1], decreasing = TRUE))
```

```{r, fig.align="center", fig.height=3, fig.cap="Relative support for products from 'dairy produce' group"}
par(mar= c(5.1, 8.1, 2, 2.1))
barplot(rev(gr_prod_1), horiz = TRUE, col = col_1, las = 1, xlim = c(0, 0.3),
       xlab = 'relative support', ylab = '', cex.axis = 0.8, cex.lab = 0.8, cex.names = 0.8)
abline(v = mean(gr_prod_1), col = col_3, lwd = 2, lty = 2)
```
<br>

2. grupa 'chleb i wypieki' ( _bread and backed goods_ ) - produkty:

```{r}
(items_lvl2_2 <- list_lvl2$`bread and backed goods`)
```

Wsparcie produktów
```{r}
(gr_prod_2 <- sort(tab_freq[items_lvl2_2], decreasing = TRUE))
```

```{r, fig.align="center", fig.height=3, fig.cap="Relative support for products from 'bread and backed goods' group"}
par(mar= c(5.1, 8.1, 2, 2.1))
barplot(rev(gr_prod_2), horiz = TRUE, col = col_1, las = 1, xlim = c(0, 0.25),
       xlab = 'relative support', ylab = '', cex.axis = 0.8, cex.lab = 0.8, cex.names = 0.8)
abline(v = mean(gr_prod_1), col = col_3, lwd = 2, lty = 2)
```
<br>

3. grupa 'napoje niealkoholowe' ( _non-alc. drinks_ ) - produkty:

```{r}
(items_lvl2_3 <- list_lvl2$`non-alc. drinks`)
```

Wsparcie produktów
```{r}
(gr_prod_3 <- sort(tab_freq[items_lvl2_3], decreasing = TRUE))
```
```{r, fig.align="center", fig.height=3, fig.cap="Relative support for products from 'non-alc. drinks' group"}
par(mar= c(5.1, 8.1, 2, 2.1))
barplot(rev(gr_prod_3), horiz = TRUE, col = col_1, las = 1, xlim = c(0, 0.25),
       xlab = 'relative support', ylab = '', cex.axis = 0.8, cex.lab = 0.8, cex.names = 0.8)
abline(v = mean(gr_prod_3), col = col_3, lwd = 2, lty = 2)
```

<br>

# EKSPERYMENT - REGUŁY 

Przeprowadzono trzy wersje eksperymentu. Każda z nich prowadzona była osobno dla pojedynczych produktów i dla grup produktów ( _level 2_ ) 
-  **1. podejście:**   support = 0.003, confidence = 0.2,

-  **2. podejście:**   support = 0.03,  confidence = 0.2,
  
-  **3. podejście:**   support = 0.003, confidence = 0.5,


## Model apriori "produkty" - 1. podejście 
```{r, warning=FALSE, include=FALSE}
rules_groc <- apriori(data = Groceries, parameter = list(support = 0.003, confidence = 0.2))
``` 
Założenia:
                 
* przyjęto _minSup_ = 0.003, to oznacza że produkt musi mieć wsparcie bezwzględne powyżej 29 transakcji
* przyjęto _minConf_ = 0.2 co oznacza, iż jeżeli w lhs są wskazane produkty to 20% rhs będzie zgodne z regułą

```{r, fig.align="center", fig.height=3, fig.cap="Length of the associate rules = LHS+RHS (products)"}
barplot(table(size(rules_groc)), col = col_1,  cex.axis = 0.8, cex.names = 0.8, cex.lab = 0.8, las = 1,
        xlab = 'length of rule')
```

```{r}
summary(rules_groc)
```

<u> PODSUMOWANIE </u>

Znalezieno 2246 reguł asocjacyjnych dla żądanych parametrow przeszukiwania;
większośc reguł - 1514 z 2246 (67,4%) - ma długość (lhs+rhs) równa 3 (3 elementy)
<br>

```{r}
inspect(sort(rules_groc, by = 'lift')[1:10])
```
Reguły o wartości lift = x oznacza, że elementy z LHS i RHS występują ze sobą x razy częściej w porównaniu do zakupów,
gdzie zakłada się, że nie mają ze sobą związku; tzn.

* produkty spożywcze typu instant i mięso na hamburgery są kupowae 11 razy częściej razem niż osobno (regula [1]), 

* serki topione i białe pieczywo kupowane są razem 8,5 raza częściej łącznie niż osobno (regula [3])

<br>
```{r}
inspect(sort(rules_groc, by = 'confidence')[1:10])
```
Reguły o wartości pewności = x oznaczają, że za każdym razem, gdy zakupiono produkty z LHS, produkty z RHS  
były kupowane w x przypadków. (conf(X->Y) można intepretować jak prawdopodobieństwo warunkowe P(Y|X)) tzn.

* gdy zakupiono owoce cytrusowe, owoce tropikalne, warzywa korzeniowe, mleko pełne to w 88% przypadków zakupiono inne warzywa,
równiez inne warzywa (reguła [1]);

* gdy zakupiono warzywa korzeniowe, masło i jogurt to w 79% przypadkach zakupiono również mleko pełne (regula [2]);

* gdy zakupiono owoce cytrusowe, owoce tropikalne, warzywa korzeniowe to w 79% przypadków
zakupiono również inne warzywa (regula [3]),
<br>
```{r}
inspect(sort(rules_groc, by = 'support')[1:10])
```
Reguła o wartości wsparcia względnego = x oznacza, że x transakcji zawiera wymienione w LHS i RHS produkty, tzn.

* reguła o wsparciu względnym 0,25 oznacza, iż w 25% transakcji wystęþuje mleko pełne (count = 2513)(regula [1]);

* reguła pełne mleko <=> inne warzywa o wsparciu względnym 0,075 oznacza, iż pełne mleko i inne warzywa występują razem
w 7,5% transakcji (w tym wypadku nie ma znaczenia co jest następnikiem, a co poprzednikiem) (regula [2], [3]);

* reguła bułki i bułeczki <=> jogurt o wsparciu względnym 0,057 oznacza, iż bułki i bułeczki oraz jogurt występują razem
w 7,5% transakcji (w tym wypadku nie ma znaczenia co jest następnikiem, a co poprzednikiem) (regula [4], [5]).

<br>

<u>Parametry określające 'jakość' otrzymanych reguł (przegląd)</u>

<!-- ```{r, fig.align="center", fig.cap="Boxplot of quality measures"} -->
<!--  boxplot(quality(rules_groc)[1:3], horizontal = TRUE, col = c(col_4, col_2, col_0), las = 1, cex.axis = 0.8, cex.lab = 0.8, frame = FALSE) -->
<!-- ``` -->

```{r, fig.align="center", fig.height=3, fig.cap="Boxplot of quality measures - support"}
boxplot(quality(rules_groc)[1], horizontal = TRUE, col = col_0, 
        cex.axis = 0.8, cex.lab = 0.8, las = 1, outline = FALSE, frame = FALSE, ylim = c(0, 0.02))
```

```{r, fig.align="center", fig.height=3, fig.cap="Boxplot of quality measures - confidence"}
boxplot(quality(rules_groc)[2], horizontal = TRUE, col = col_2, 
        cex.axis = 0.8, cex.lab = 0.8, las = 1, frame = FALSE, ylim = c(0, 1))
```

```{r, fig.align="center", fig.height=3, fig.cap="Boxplot of quality measures - lift"}
boxplot(quality(rules_groc)[3], horizontal = TRUE, col = col_4, 
        cex.axis = 0.8, cex.lab = 0.8, las = 1, outline = FALSE, frame = FALSE, ylim = c(0, 0.05))
```

**Wnioski dot. wartości miar jakości reguł**

1. wsparcie względne max wynosi 25,5% (wsparcie bezwzględne 2513), natomiast średnie wsparcie względne
    wynosi 0,6% (wsparcie bezwzględne 61,8) - co prawie pokrywa się z kwantylem 3/4
2. zaufanie max wynosi 88,5%, zaufanie min = 20%, natomiast zaufanie średnie wynosi 36,7% (w przybliżeniu można
    powiedziec że w 1 na 3 przypadki po zakupieniu produktów LHS kupowane sa RHS)
3. lift max wynosi 11,4, co jest jednak outlierem - z wykresu widać, iż zaczynają się one powyżej wartości 4; 
    wartością średnią jest 2,25 (powyżej 4 zaczynają się outliery)
    
<br>

<u> Analiza długości reguł </u>
```{r, fig.align="center", fig.height=3, fig.cap="Length of the associate rules = LHS+RHS"}
barplot(table(size(rules_groc)), col = col_1, cex.axis = 0.8, cex.names = 0.8, cex.lab = 0.8, las = 1,
        xlab = 'length of rule')
```

**Wnioski dot. długości reguł**

67,4% (1514/2246) reguł ma długość (LHS+RHS) wynoszącą 3 (reguła składa się z trzech elementów = produktów), natomiast 17% i 15,7% ma długość  odpowiednio - 2 i 4; występuje jedna reguła, gdzie LHS to zbiór pusty.


<br> 
<u> Analiza długości LHS i RHS </u>
```{r}
summary(size(rules_groc@rhs))
```
Wszystkie poprzedniki mają długość 1
<br>
```{r}
summary(size(rules_groc@lhs))
```
```{r, fig.align="center", fig.height=3, fig.cap="Length of the associate rules - LHS"}
barplot(table(size(rules_groc@lhs)), col = col_1,  cex.axis = 0.8, cex.names = 0.8, las = 1)
```
67% (1514 z 2246) reguł ma następnik o długości 2, zbiory następników o długości 1 i 3 to 16% reguł każda.

<br>

## Model apriori "grupy produktów" - 1. podejście 
```{r, warning=FALSE, include=FALSE}
rules_groc_lvl2 <- apriori(data = Groceries_lvl2, parameter = list(support = 0.003, confidence = 0.2, minlen = 2))
``` 
Założenia:
                 
* przyjęto _minSup_ = 0.003, to oznacza, że grupa produktów musi mieć wsparcie bezwzględne powyżej 29 transakcji
* przyjęto _minConf_ = 0.2 co oznacza, iż jeżeli w lhs są wskazane grupy produktóœ to 20% rhs będzie zgodne z regułą

```{r, fig.align="center", fig.height=3, fig.cap="Length of the associate rules = LHS+RHS (products group)"}
barplot(table(size(rules_groc_lvl2)), col = col_1, cex.axis = 0.8, cex.names = 0.8, las = 1)
```

```{r}
summary(rules_groc_lvl2)
```

<u> PODSUMOWANIE </u>

Znalezieno 8411 reguł asocjacyjnych dla żądanych parametrów przeszukiwania, tj. support = 0.003, confidence = 0.2 oraz minlen=2
42% reguł - 3548 z 8411 - ma długość (lhs+rhs) równą 4 (4 elementy), a 27% i 22% reguł - ma długość - odpowiednio 3 i 5 elementów.
<br>

```{r}
inspect(sort(rules_groc_lvl2, by = 'lift')[1:10])
```
Reguły o wartości lift = x oznacza, że elementy z LHS i RHS występują ze sobą x razy częściej w porównaniu do zakupów
gdzie zakłada się, że nie mają ze sobą zwiazku; tzn.
* produkty z grup: produkty mleczne, słodycze,ocet/olej wraz z podstawowymi produktami (mąka, ryz, kasze) są 9,2 raza
częściej kupowane razem niż osobno (dotyczy LHS i RHS) (reguła [1]),

* słodycze oraz ocet/olej są kupowane razem z podstawowymi produktami (mąka, ryz, kasze) 8,3 raza częściej niż osobno (reguła [2])

* reguła [3] jest bardzo podobna do [1] - ale lift = 8,0

* reguła [4] jest bardzo podobno do [2] - ale lift = 7,5

<br>
```{r}
inspect(sort(rules_groc_lvl2, by = 'confidence')[1:10])
```
Reguły o wartości pewności = x oznacza, że za każdym razem, gdy zakupiono produkty z LHS, produkty z RHS były kupowane x przypadków 
(conf(X->Y) można intepretować jak prawdopodobieństwo warunkowe P(Y|X)) tzn. jeżeli zakupiono produkty z grup czekolada, owoce,
podstawowe produkty (mąka, ryz, kasze) to na 100% zakupiono produkt z działu produkty mleczne (reguła [1].)

**UWAGA** ponieważ produkty mleczne występują w 44% transakcji - tworzą reguły o dużej pewności, gdy są w następniku
wynika to z definicji conf(X->Y) = sup(X->Y) / sup(X)  (produkty mleczne 'budują' wartość sup(X->Y))
<br>

Sprawdzenie jak wyglądaja reguły, gdy poprzednikiem są produkty mleczne
```{r}
inspect(sort(subset(rules_groc_lvl2, subset = lhs %in% 'dairy produce' & confidence > 0.80), by = 'confidence'))
```
Należy zauważyć, iż reguły zawierające w poprzedniku 'produkty mleczne' mają równiez stosunkowo duża pewność, a następnikiem
są grupy produktów z największym wsparciem, tj. 'pieczywo i wypieki' oraz 'warzywa' (bardzo duże sup(X->Y)) - z 258 reguł pokazane są 3 przykałdowe:

```{r}
inspect(sort(subset(rules_groc_lvl2, subset = lhs %in% 'bread and backed goods' & confidence > 0.80), by = 'confidence')[c(1, 129, 258)])
```

**CIEKAWOSTKA** jeżeli w poprzedniku występuje produkt z grupy 'pieczywo i wypieki' to z pewnością **> 0,80** w następniku wystąpi 
produkt z działu 'produkty mleczne' (takich reguł jest 258); z powyższego zestawieni wynika, iż jeżeli w poprzedniku wystąpiła 
grupa 'produkty mleczne' to z pewnością **> 0,80** wystąpia podukty z grupy 'pieczywo i wypieki' lub 'warzywa'.
<br>
```{r}
inspect(sort(rules_groc_lvl2, by = 'support')[1:10])
```
Reguła o wartości wsparcia względnego = x oznacza, że x transakcji zawiera wymienione w LHS i RHS produkty.

* reguła o wsparciu względnym 0,18 oznacza, iż w 18% transakcji występują produkty z działu produkty mleczne
oraz pieczywo i wypieki (tu co jest następnikiem a co poprzednikiem nie ma znaczenia) (reguła [1], [2]),

* reguła o wsparciu względnym 0,17 oznacza, iż w 17% transakcji występują produkty z działu warzywa
oraz produkty mleczne (tu co jest następnikiem a co poprzednikiem nie ma znaczenia) (reguła [3], [4]),

* reguła o wsparciu względnym 0,156 oznacza, iż w 15,6% transakcji występują produkty z działu owoce
oraz produkty mleczne (tu co jest następnikiem a co poprzednikiem nie ma znaczenia) (reguła [5], [6]),

* reguła o wsparciu względnym 0,152 oznacza, iż w 15,2% transakcji występują produkty z napoje niealkoholowe
oraz produkty mleczne (tu co jest następnikiem a co poprzednikiem nie ma znaczenia) (reguła [7], [8]),

* reguła o wsparciu względnym 0,124 oznacza, iż w 12,4% transakcji występują produkty z napoje niealkoholowe
oraz pieczywo i wypieki (tu co jest następnikiem a co poprzednikiem nie ma znaczenia) (reguła [9], [10]).

<br>
Powyższe reguły sa zbudowane z grup produktów o największym wsparciu (częste produkty dają częste reguły), ale
aby znaleźć odpowiedź na pytanie, które działy sklepu należy rozwijać, należy przeanalizować jeszcze zaufanie ww. reguł.
tzn. zakup których grup produktów warunkuje zakup innych grup.


<u>Parametry określające 'jakość' otrzymanych reguł (przegląd)</u>
<!-- # ```{r, fig.align="center", fig.cap="Boxplot of quality measures"} -->
<!-- # boxplot(quality(rules_groc_lvl2)[1:3], horizontal = TRUE, col = c(col_4, col_2, col_0), las = 1, cex.axis = 0.8, cex.lab = 0.8, frame = FALSE) -->
<!-- # ``` -->

```{r, fig.align="center", fig.height=3, fig.cap="Boxplot of quality measures - support"}
boxplot(quality(rules_groc_lvl2)[1], horizontal = TRUE, col = col_0, 
        cex.axis = 0.8, cex.lab = 0.8, las = 1,  frame = FALSE, ylim = c(0, 0.02))
```

```{r, fig.align="center", fig.height=3, fig.cap="Boxplot of quality measures - confidence"}
boxplot(quality(rules_groc_lvl2)[2], horizontal = TRUE, col = col_2, 
        cex.axis = 0.8, cex.lab = 0.8, las = 1, frame = FALSE, ylim = c(0, 1.2))
```

```{r, fig.align="center", fig.height=3, fig.cap="Boxplot of quality measures - lift"}
boxplot(quality(rules_groc_lvl2)[3], horizontal = TRUE, col = col_4, 
        cex.axis = 0.8, cex.lab = 0.8, las = 1, frame = FALSE, ylim = c(0, 0.2))
```

<br>

**Wnioski dot. wartości miar jakości reguł**

1. wsparcie względne max wynosi 18,8% (wsparcie bezwzględne 1846), natomiast średnie wsparcie względne
  wynosi 0,7% (wsparcie bezwzględne 71,0) - co prawie pokrywa się z kwantylem 3/4, ale jest ciut wyższe - 
  z wykresu widać, iż dla wsparcia bezwzględnego powyżej 120 występują ouliery.
2. zaufanie max wynosi 100%, zaufanie min = 20%, natomiast zaufanie średnie wynosi 51% (w przybliżeniu można
  powiedziec że w 50% przypadków po zakupieniu produktów LHS kupowane są RHS)
3. lift max wynosi 9,16, co jest jednak outlierem - z wykresu widać, iż zaczynają się one powyżej wartości 3,5; 
  wartością średnią jest 2,05.
  
<br>

## Model apriori "produkty" - 2. podejście 
```{r, warning=FALSE, include=FALSE}
ap_param <- new('APparameter', 'confidence' = 0.2, 'support' = 0.03, 'minlen' = 2, maxtime = 20) 
rules_groc_new <- apriori(Groceries, ap_param)
``` 
Założenia:
                 
* przyjęto _minSup_ = 0.03, to oznacza że produkt musi mieć wsparcie bezwzględne powyżej 295 transakcji
* przyjęto _minConf_ = 0.2 co oznacza, iż jeżeli w lhs są wskazane produkty to 20% rhs będzie zgodne z regułą

```{r, fig.align="center", fig.height=3, fig.cap="Length of the associate rules = LHS+RHS (products)"}
barplot(table(size(rules_groc)), col = col_1, cex.axis = 0.8, cex.names = 0.8, cex.lab = 0.8, las = 1,
        xlab = 'lenght of rule')
```

```{r}
summary(rules_groc_new)
```

<u> PODSUMOWANIE </u>

Znalezieno 25 reguł asocjacyjnych dla żądanych parametrów przeszukiwania; wszytkie reguły mają długośc 2 (2 elementy w lhs+rhs).
<br>

```{r}
inspect(sort(rules_groc_new, by = 'lift')[1:10])
```
Reguły o wartości lift = x oznacza, że elementy z LHS i RHS występują ze sobą x razy częściej w porównaniu do zakupów
gdzie zakłada się, że nie mają ze sobą zwiazku; tzn.

* warzywa korzeniowe oraz inne warzywa są kupowane 2,2 razy częściej razem niż osobno, 
(reguła ta niezależnie od kolejności ma takie samo wsparcie i lift, ale zależenie od kolejności - inne zaufanie różniące się dwukrotnie)
(reguła [1], [2])

* kiełbasa oraz bułki i bułeczki kupowane są 1,77 razy częściej razem niż osobno (reguła [3]), 

* owoce tropikalne i inne warzywa kupowane są 1,77 razy częściej razem niż osobno (reguła [4]).

Zwraca uwagę fakt, iż w zasadzie reguły te są zbudowane tylko z produktów częstych (z wyjątekim [3] gdzie lhs = {sausage})
W porównaniu reguł w 1. podejściu - zwraca uwagę spadek wartości lift dla reguł 
(poprzedniu było powyżej 4,9 - do 11 - teraz jest max 2,2)

```{r}
inspect(sort(rules_groc_new, by = 'confidence')[1:10])
```
Reguły o wartości pewności = x oznacza, że za każdym razem, gdy zakupiono produkty z LHS, produkty z RHS były również kupowane 
x przypadków (conf(X->Y) można intepretować jak prawdopodobieństwo warunkowe P(Y|X)) tzn.

* gdy zakupiono bitą śmietanę i śmietanę zwykłą to w 45% przypadków zakupiono też mleko pełne (reguła [1]),

* gdy zakupiono warzywa korzeniowe to w 44,9% przypadkach zakupiono również mleko pełne (reguła [2]),

* gdy zakupiono warzywa korzeniowe to w 43,4% przypadkach zakupiono również inne warzywa (reguła [3]).

W porównaniu reguł w 1. podejściu - zwraca uwagę spadek wartości zaufania reguł 
(poprzednio było powyżej 70% teraz jest max 45%)
```{r}
inspect(sort(rules_groc_new, by = 'support')[1:10])
```
Reguła o wartości wsparcia względnego = x oznacza, że x transakcji zawiera wymienione w LHS i RHS produkty.

* reguła pełne mleko <=> inne warzywa o wsparciu względnym 0,075 oznacza, iż pełne mleko i inne warzywa występują razem
w 7,5% transakcji (nie ma znaczenia co jest tu poprzednikiem, a co następnikiem) (reguła [1], [2]),

* reguła bułki i bułeczki <=> jogurt o wsparciu względnym 0,057 oznacza, iż bułki i bułeczki oraz jogurt występują razem
w 5,7% transakcji (nie ma znaczenia co jest tu poprzednikiem, a co następnikiem) (reguła [3], [4]).

Reguły powyższe - z wyjątkiem, że tu nie występuje reguła ze zbiorem pustym - są takie same jak otrzymano w 1. podejściu 
<br>

<u>Sprawdzenie</u>

* dla reguł [1] i [2] - wsparcie 736 transakcje zawierają produkty inne warzywa oraz mleko pełne (wybrano 3 przykładowe)
```{r}
inspect(subset(subset(Groceries, items %in% 'other vegetables'), items %in% 'whole milk')[c(1, 368, 736)])
```

* dla reguł [3] i [4] - wsparcie 557 transakcje zawierają produkty bułki i bułeczki oraz mleko pełne (wybrano 3 przykładowe)
```{r}
inspect(subset(subset(Groceries, items %in% 'rolls/buns'), items %in% 'whole milk')[c(1, 278, 557)])
```
<br>

**WNIOSKI**

Zwiększczenie wartości minimalnego wsparcia wzglednego ( _minrSup_ = 0.03) spowodowało skrócenie reguł - do dwóch elementów: jeden poprzednik i jeden nastepnik, natomiast zasadniczo nie zmieniło zestawienia reguł wg parametru wsparcie bezwzględne;
reguły przefitrowane wg parametru lift i zaufanie zawierają najczęstsze produkty - zmiana w stosunku
do otrzymanych w 1.podejeściu zestawień wynikająca z wymaganego większego wsparcia poprzedznika reguły
(dla zaufania conf = P(XY) / P(X) oraz dla lift = P(XY)/ [P(X) * P(Y)]).

<br>

## Model apriori "grupy produktów" - 2. podejście 
```{r, warning=FALSE, include=FALSE}
rules_groc_lvl2_new <- apriori(Groceries_lvl2, ap_param)
``` 
Założenia:
                 
* przyjęto _minSup_ = 0.03, to oznacza, że grupa produktów musi mieć wsparcie bezwzględne powyżej 295 transakcji
* przyjęto _minConf_ = 0.2 co oznacza, iż jeżeli w lhs są wskazane grupy produktów, to 20% rhs będzie zgodne z regułą

```{r, fig.align="center", fig.height=3, fig.cap="Length of the associate rules = LHS+RHS (products group)"}
barplot(table(size(rules_groc_lvl2_new)), col = col_1, cex.axis = 0.8, cex.names = 0.8, cex.lab = 0.8, las = 1,
        xlab = 'lengthof rule')
```

```{r}
summary(rules_groc_lvl2_new)
```

<u> PODSUMOWANIE </u>

Znalezieno 193 reguł asocjacyjnych dla żądanych parametrów przeszukiwania, tj. support = 0.03, confidence = 0.2, minnlen=2
44,5% reguł - 86 z 193 - ma długość (lhs+rhs) równą 2 (2 elementy), 43% reguł - 83 z 193 - ma długość (lhs+rhs) równą 3 (3 elementy), a
pozostałe reguły maja długość 4 (4 elementy)

<br>
```{r}
inspect(sort(rules_groc_lvl2_new, by = 'lift')[1:10])
```
Reguły o wartości lift = x ozanczają, że elementy z LHS i RHS występują ze sobą x razy częściej w porównaniu do zakupów
gdzie zakałda się, że nie mają ze sobą związku; tzn.

* produkty z grup: produkty mleczne i kiełabsy wraz z serem są 2,3 raza częściej kupowane razem niż osobno (dotyczy LHS i RHS) (reguła [1]),

* pieczywo i wypieki, produkty mleczne i warzywa razem z kiełbasą są 2,1 raza częściej kupowane niż osobno (reguła [2]),

* pieczywo i wypieki, produkty mleczne i owoce razem z kiełbasą są 2,1 raza częściej kupowane niż osobno (reguła [3]).

Wartości lift są przeciętnie niższe niż w 1. podejściu max. 9,1 (outlier) i 2,3 na Q3 
vs max. 2,3 w podejściu 2., różnice wartości nie są jednak tak znaczne jak w przypadku pojedynczych produktów.

```{r}
inspect(sort(rules_groc_lvl2_new, by = 'confidence')[1:10])
```
Reguły o wartości pewności = x oznacza, że za każdym razem, gdy zakupiono produkty z LHS, produkty z RHS były kupowane x przypadków 
conf(X->Y) można intepretować jak prawdopodobieństwo warunkowe P(Y|X)), tzn.

* jeżeli zakupiono produkty z grup pieczywo i wypieki, owoce i kiełbasy to w 80% transakcji zakupiono produkty mleczne (reguła [1]),

* jeżeli zakupiono produkty z grup pieczywo i wypieki, owoce i warzywa to w 80% transakcji zakupiono produkty mleczne (reguła [2])

* jeżeli zakupiono produkty z grup sery i owoce to w 77% transakcji zakupiono produkty mleczne (reguły [3]).

Zwraca uwagę fakt, iż reguły powstały z elementów częstych, w porównaniu do reguł z 1. podejścia = następnik jest taki sam
(produkty mleczne) natomiast zmieniła się cześć poprzedników (wymagane wyższe wsparcie), ale reguły mają mniejsze zaufanie
(było powyżej 95% jest teraz mniej niż 80%)

**UWAGA** ponieważ produkty mleczne występują w 44% transakcji - tworzą reguły o dużej pewności, gdy są w następniku.

```{r}
inspect(sort(rules_groc_lvl2_new, by = 'support')[1:10])
```
Reguła o wartości wsparcia względnego = x oznacza, że x transakcji zawiera wymienione w LHS i RHS produkty.
reguła o wsparciu względnym 0,18 oznacza, iż w 18% transakcji występują produkty z działu produkty mleczne
oraz pieczywo i wypieki (tu co jest następnikiem a co poprzednikiem nie ma znaczenia) (reguła [1], [2]).
Reguły powyższe - z wyjątkiem, że tu nie występuje reguła ze zbiorem pustym - są takie same jak otrzymano w 1. podejściu 

<br>

## Model apriori "produkty" - 3. podejście 
```{r, warning=FALSE, include=FALSE}
ap_param_3 <- new('APparameter', 'confidence' = 0.5, 'support' = 0.003, 'minlen' = 2, maxtime = 20) 
rules_groc_new_3 <- apriori(Groceries, ap_param_3)
``` 
Założenia:
                 
* przyjęto _minSup_ = 0.003, to oznacza że produkt musi mieć wsparcie bezwzględne powyżej 29 transakcji
* przyjęto _minConf_ = 0.5 co oznacza, iż jeżeli w lhs są wskazane produkty to 50% rhs będzie zgodne z regułą

```{r, fig.align="center", fig.height=3, fig.cap="Length of the associate rules = LHS+RHS (products)"}
barplot(table(size(rules_groc_new_3)), col = col_1, cex.axis = 0.8, cex.names = 0.8, las = 1)
```

```{r}
summary(rules_groc_new_3)
```

<u> PODSUMOWANIE </u>

Znalezieno 421 reguł asocjacyjnych dla żądanych parametrów przeszukiwania, tj. support = 0.003, confidence = 0.5; 
większośc reguł - 281 z 421 (66,7%) - ma długość (lhs+rhs) równa 3 (3 elementy), a
spora część reguł - 128 z 421 (30%) - ma długość (lhs+rhs) równa 4 (4 elementy)
<br>

```{r}
inspect(sort(rules_groc_new_3, by = 'lift')[1:10])
```
Reguły o wartości lift = x ozancza, że elementy z LHS i RHS występują ze sobą x razy częściej w porównaniu do zakupów
gdzie zakałda się, że nie mają ze sobą związku; tzn.

* cytrusy, owoce tropikalne, inne warzywa i pełne mleko oraz warzywa korzeniowe są kupowane 5,8 razy częsciej razem niż osobno (reguła [1]), 

* cytrusy, warzywa korzeniowe, inne warzywa i pełne mleko oraz woce tropikalne są kupowane 5,2 razy częsciej razem niż osobno (reguła [2), 

* zioła i mleko pełne oraz warzywa korzeniowe są kupowane 4,9 razy częsciej razem niż osobno  (reguła [3]).

Zwraca uwagę fakt, iż w zasadzie reguły te są zbudowane głównie z produktów częstych, ale pojawiają się też produkty o znacznie 
niższym wsparciu (ale z częstych grup produktów).

```{r}
inspect(sort(rules_groc_new_3, by = 'confidence')[1:10])
```
Reguły o wartości pewności = x oznacza, że za każdym razem, gdy zakupiono produkty z LHS, produkty z RHS były również kupowane 
x przypadków (conf(X->Y) można intepretować jak prawdopodobieństwo warunkowe P(Y|X)) tzn.

* gdy zakupiono cytrusy, owoce tropikalne, warzywa korzeniowe i pełne mleko to w 88% przypadków zakupiono też minne warzywa (reguła [1]),

* gdy zakupiono warzywa korzeniowe, masło i jogurt to w 79% przypadkach zakupiono również mleko pełne (reguła [2]),

* gdy zakupiono cytrusy, owoce tropikalne i warzywa korzeniowe to w 79% przypadkach zakupiono również mleko pełne (reguła [3]).

W porównaniu reguł w 1. podejściu - otrzymaliśmy te same reguły .

```{r}
inspect(sort(rules_groc_new_3, by = 'support')[1:10])
```
Reguła o wartości wsparcia względnego = x oznacza, że x transakcji zawiera wymienione w LHS i RHS produkty.

* reguła inne warzywa i jogurt => pełne mleko o wsparciu względnym 0,022 oznacza, iż produkty te występują razem w 2,2% transakcji (reguła [1]),

* reguła owoce tropikalne i jogurt => pełne mleko o wsparciu względnym 0,015 oznacza, iż produkty te występują razem 1,5% transakcji (reguła [2]).

**CIEKAWOSTKA** Powyższe reguły mają pewność > 50%, czyli są prawdziwe dla połowy zakupów zawierajcych lhs!
Reguły powyższe są zupełnie inne niż jak otrzymano w 1. podejściu i 2. podjeściu.

<br>

## Model apriori "grupy produktów" - 3. podejście 
```{r, warning=FALSE, include=FALSE}
rules_groc_lvl2_new_3 <- apriori(Groceries_lvl2, ap_param_3)
``` 
Założenia:
                 
* przyjęto _minSup_ = 0.003, to oznacza, że grupa produktów musi mieć wsparcie bezwzględne powyżej 29 transakcji
* przyjęto _minConf_ = 0.5 co oznacza, iż jeżeli w lhs są wskazane grupy produktów to 50% rhs będzie zgodne z regułą

```{r, fig.align="center", fig.height=3, fig.cap="Length of the associate rules = LHS+RHS (products group)"}
barplot(table(size(rules_groc_lvl2_new_3)), col = col_1, cex.axis = 0.8, cex.names = 0.8, cex.lab = 0.8, las = 1,
        xlab = 'length of rule')
```

```{r}
summary(rules_groc_lvl2_new_3)
```
<u> PODSUMOWANIE </u>

Znalezieno 4417 reguł asocjacyjnych dla żądanych parametrów przeszukiwania, tj. support = 0.003, confidence = 0.5
44,5% reguł - 2007 z 4417 (45,4%- ma długość (lhs+rhs) równą 4 (4 elementy); 1225 (27,7%) i 884 (20%) m a - odpowiednie - długość 3 i 5  

```{r}
inspect(sort(rules_groc_lvl2_new_3, by = 'lift')[1:10])
```
Reguły o wartości lift = x ozancza, że elementy z LHS i RHS występują ze sobą x razy częściej w porównaniu do zakupów
gdzie zakałada się, że nie mają ze sobą związku; tzn.

* produkty z grup produkty mleczne, owoce, kiełabsy, warzywa oraz ocet i oleje wraz z serami są 4,3 raza częściej kupowane razem niż osobno (dotyczy LHS i RHS) (reguła [1]),

* owoce, kiełabsy, warzywa oraz ocet i oleje wraz z serami są 4 razy częściej kupowane niż osobno (reguła [2]),

* pieczywo i wypieki, jajka, owoce i kiełbasy wraz z serami są 4 razy częściej kupowane niż osobno (reguła [3]).

```{r}
inspect(sort(rules_groc_lvl2_new_3, by = 'confidence')[1:10])
```
Reguły o wartości pewności = x oznacza, że za każdym razem, gdy zakupiono produkty z LHS, produkty z RHS były kupowane x przypadków 
conf(X->Y) można intepretować jak prawdopodobieństwo warunkowe P(Y|X)), tzn.

* jeżeli zakupiono produkty z grup czekolady, owoce i podstawowe produkty (mąka, ryż, kasze) to w 100% transakcji zakupiono produkty mleczne (reguła [1]),

* jeżeli zakupiono produkty z grup jajka, owoce i podstawowe produkty (mąka, ryż, kasze) to w 97% transakcji zakupiono produkty mleczne (reguła [2]), 

* jeżeli zakupiono produkty z grup sery, jajka i perfumeria to w 97% transakcji zakupiono produkty mleczne (reguła [3]).

Zwraca uwagę fakt, iż reguły powstały niekoniecznie z elementów częstych, w porównaniu do reguł z 1. podejścia i 2.podejścia
- w zasadzie następnik jest ten sam (produkty mleczne); reguły mają bardzo wysokie zaufanie - powyżej 95%.

**UWAGA** ponieważ produkty mleczne występują w 44% transakcji - tworzą reguły o dużej pewności, gdy są w następniku.

```{r}
inspect(sort(rules_groc_lvl2_new_3, by = 'support')[1:10])
```
Reguła o wartości wsparcia względnego = x oznacza, że x transakcji zawiera wymienione w LHS i RHS produkty.

* reguła o wsparciu względnym 0,18 oznacza, iż w 18% transakcji występują produkty z działu produkty mleczne (reguła [1]),

* reguła o wspraciu względnym 0,17 oznacza, iż w 17% transakcji zawiera warzywa i produkty mleczne (reguła [2]).

Reguły powyższe - w następniku maja głównie  element produkty mleczne, w poprzedniku zaś - elementy częste.
Dla pierwszych 5 reguł zauważyć należy, że przy wysokim wsparciu względnym >10% reguły mają też stosunkowo duże
zaufanie - w granicach 0.55-0.63.



# PODSUMOWANIE

## Podsumowanie dot. zbioru danych

najczęściej występujące w listach zakupowych produkty to:
```{r}
tab_freq[list_pop_products]
```

najczęściej występujące grupy produktów (= działy sklepu) to:
```{r}
tab_freq_lvl2[list_pop_gr_products]
```
a produkty w częstych grupach produktów to:
```{r}
list_lvl2$`dairy produce`; list_lvl2$`bread and backed goods`
```

<br>

## Podsumowanie dot. przeprowadzonych eksperymetów

Przeprowadzono trzy eksperymenty - niezależnie dla produktów i grup produktów - dla parametrów:
  1. podejście   support = 0.003, confidence = 0.2
  
  2. podejście   support = 0.03,  confidence = 0.2
  
  3. podejście   support = 0.003, confidence = 0.5


Do dalszej analizy i ostatecznych wniosków wybrano zbiór reguł, które <u>powstały w 3.podejściu</u>, 
ze względu na wysoką wartość zaufania.

Analizując reguły o wysokiej wartości zaufania na poziomie produktów
```{r}
inspect(sort(rules_groc_new_3, by = 'confidence')[1:10])
```
analizowano uwzględniając równiez ich wsparcie:
```{r}
inspect(sort(rules_groc_new_3, by = 'support')[1:10])
```

Pierwsza zależność (reguły sortowane wg wsparcia), rzucająca się w oczy to, że <span class="text-primary"> jeżeli warzywa i owoce to 
zakupiono również pełne mleko </span>- są to reguły z zaufaniem > 78,5%; w regułach o niższym zaufaniu pojawiają się też
produkty z innych grup produktów, tj. 'pieczywo' i 'inne rzadkie'.

Pośród reguł posortowanych wg wartości wsparcia zależność jest <span class="text-primary"> jeżeli warzywa lub owoce oraz produkt z grupy 
produkty mleczne (jogurt lub bita śmietana i śmietana zwykła)to pełne mleko lub inne warzywa </span> - są to reguły ze wsparciem 
względnym > 0,012 (wsparcie bezwzględne > 118) oraz z zaufaniem > 50% (<u> czyli 1 na 2 transakcje na pewno będą tak wyglądały </u>).

Zasadniczo pierwsze 30 reguł z tej listy opiera sie o produkty z grupy 'warzywa' i 'owoce' oraz 'produkty mleczne'!
Nie dziwi to, gdy uwzględni się bardzo wysokie wsparcie 'mleka pełnego' (25,6% transakcji zawieraja ten produkt)
oraz 'innych warzyw '(19% transakcji); kolejne często występujące produkty to 'jogurt', 'warzywa korzeniowe' oraz
'owoce cytrusowe' (odpowiednio 14%, 10,9% i 10,5% transakcji) - stąd ich obecnośc w regułach o dużym zaufaniu
nie zaskakuje.

<br>

Wizualizacja wniosków
```{r}
plot(rules_groc_new_3[quality(rules_groc_new_3)$confidence > 0.73],
     method = 'matrix', shading = 'confidence', #main = '',
     control = list(col	= colorRampPalette(c("#1995dc", "#022a50"))(50)))
```
<br>
<br>
Analizując reguły o wysokiej wartości zaufania na poziomie grup produktów
```{r}
inspect(sort(rules_groc_lvl2_new_3, by = 'confidence')[1:10])
```
analizowano uwzględniając równiez ich wsparcie:
```{r}
inspect(sort(rules_groc_lvl2_new_3, by = 'support')[1:10])
```
Ciekawie wygląda reguła z 100% zaufaniem: <span class="text-primary">jeżeli kupiono produkty z grup czekolady, owoce i podstawowe produkty 
(mąka, ryż, kasze) to produkty mleczne </span>. Również ciekawe są kolejne reguły z zaufaniem graniczącym z 100% (>97%) 
jakkolwiek ich wsparcie względne jest pomijalnie małe - wynosi ~0.003-0.004 (wsparcie bezwzględne 30-38).
Reguły te zbudowane sa z produktów rzadkich, acz bardzo silne wsparcie skłania do przyjrzenia się im dokładnie
- szczególnei w kontekście ewentualnej arażacje poszczególnych działów względem siebie.

Natomiast reguły posortowane wg wsparcia dostarczają nam dwóch istotnych inforamacji - ogólna zasada
że produkt z grupy częste w poprzedniku z ponad 55% pewnością wiąże się z zakupem kolejnego produktu z grupy częstej;
a druga obserwacja - że będzie to najpewniej produkt z działu 'produkty mleczne'; dla pierwszych pięciu reguł
z tego zbioru wsparcie wynosi 10-18%, tzn. 10-18% transakcji zawiera te produkty (co pokrywa się z przyjęta definicją
elementu częstego z eksperymencie dla produktów częstych)

<hr>

**CIEKAWOSTKI**
```{r}
inspect(sort(subset(rules_groc_lvl2_new_3, subset = lhs %in% 'dairy produce' & confidence > 0.80), by = 'confidence'))
```
jeżeli w lhs jest produkt z grupy 'produktów mlecznych' to z 80% w rhs będą 'warzywa 'lub 'pieczywo i wypieki '
```{r}
inspect(sort(subset(rules_groc_lvl2_new_3, subset = lhs %in% 'bread and backed goods' & confidence > 0.80), by = 'confidence')[c(1, 64, 128, 194, 258)])
```
jeżeli w lhs jest produkt z grupy 'pieczywo i wypieki' to z 80% w rhs będzie produkt z grupy 'produkty mleczne' (258 reguł - wybrane 5)
```{r}
inspect(sort(subset(rules_groc_lvl2_new_3, subset = lhs %in% 'vegetables' & confidence > 0.80), by = 'confidence')[c(1, 67, 134, 200, 267)])
```
jeżeli w lhs jest produkt z grupy 'warzywa' to z 80% w rhs będzie produkt z grupy 'produkty mleczne' (267 reguł - wybrane 5)

**uwaga** dwa wyjątki - 186 i 258 ('pieczywo i wypieki')
```{r}
inspect(sort(subset(rules_groc_lvl2_new_3, subset = lhs %in% 'vegetables' & confidence > 0.80), by = 'confidence')[c(186, 258)])
```
<br>
```{r}
inspect(sort(subset(rules_groc_lvl2_new_3, subset = rhs %in% 'dairy produce'), by = 'confidence')[c(1, 359, 717, 1076, 1434)])
```
'produkty mleczne' występują w rhs z pewnością ponad 50% (1434 reguły - 1/3 wszystkich utworzonych - powyżej wybrane 5)
```{r}
inspect(sort(subset(rules_groc_lvl2_new_3, subset = rhs %in% 'dairy produce'), by = 'count')[1:15])
```
pierwsze trzy reguły są dwuelementowe i tworza je częste grupy produktów (<span class="text-primary">jeżeli pieczywo i wypieki / warzywa / owoce to produkty mleczne</span>) - 
reguły te mają zaufanie >54% oraz bardzo wysokie wsparcie >15,6%
```{r}
inspect(sort(subset(rules_groc_lvl2_new_3, subset = lhs %in% 'non-alc. drinks' & confidence > 0.80), by = 'support')[1:10])
inspect(sort(subset(rules_groc_lvl2_new_3, subset = rhs %in% 'non-alc. drinks' & confidence > 0.30), by = 'support')[1:10])
```
'napoje niealkoholowe' - mimo że sa częstą grupą produktów - tworzą reguły o bardzo małym wsparciu
```{r}
inspect(sort(subset(rules_groc_lvl2_new_3, subset = rhs %in% 'vegetables' & confidence > 0.75), by = 'support'))
```
jeżeli w rhs są 'warzywa' - reguły mają niskie wsparcie < 0,88%
```{r}
inspect(subset(subset(rules_groc_lvl2_new_3, items %in% 'dairy produce'), items %in% 'vegetables')[c(1, 586, 963)])
```
17% (1676 z 9835) transakcji zawiera równocześnie 'produkty mleczne' i 'warzywa' (3 wybrane zasady)
```{r}
inspect(subset(subset(rules_groc_lvl2_new_3, items %in% 'bread and backed goods'), items %in% 'vegetables')[c(1, 456, 893)])
```
11% (1143 z 9835) transakcji równoczęsnie 'pieczywo i bułeczki' oraz 'warzywa' (3 wybrane zasady)

<br>

<br>

## Podsumowanie końcowe

Z powyższych analiz wynika, że najczęściej kupowanym produktem jest 'mleko pełne', natomiast 1/3 reguł w następniku
ma 'produkty mleczne'; stąd zalecenia, aby <span class="text-info"><b>dział produktów mlecznych</b></span> 
był na samym końcu sklepu - tak, aby klient musiał przejść możliwie długa trasę. 
Mocną zależnością jest <span class="text-primary">warzywa i owoce to zakupiono również pełne mleko'</span>,
stąd <span class="text-info"><b>dział z warzywami i owocami</b></span> powinny się znaleźć na poczatku sklepu 
(szczególnie, że reguły mające w następniku warzywa mają bardzo małe wsparcie). 

W regułach opartych na częstych grupach produktów zaobserwoano silną zależność 
pomiędzy 'produktami mlecznymi' a 'pieczywem i wypiekami', co sugerowałoby, że <span class="text-info"><b>dział z pieczywme</b></span>
powinien być zlokalizowany obok <span class="text-info"><b>działu z warzywami i owocami</b></span> - 
ewentualnie przedzielony jakimś działem rzadkim (zakupy impulsowe). 

Szczególnie popularnym produktem są 'bułki i bułeczki' (18% transakcji), stąd zaleca się szczególnie skupić na rozwoju 
oferty tych produktów. Uwzględniając niezwykle duże wsparcie 'mleka pełnego' (25%) zaleca się dołożenie wszelkich starań, 
by go nie zabrakło w ofercie. Nadmienić należy, iż podobnie wysoką pozycje ma 'jogurt' (14%).

Warto zauważyć, iż o ile grupa produktów 'napoje niealkoholowe' jest częsta, nie wytwarz ona częstych reguł - 
bardzo małe wsparcie tej grupy sugerowałoby zlokalizowanie <span class="text-info"><b>działu z napojami</b></span> z boku sklepu.








